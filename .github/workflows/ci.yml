name: churn-imbalanced-dataset

on: [push]

permissions:
  contents: write
  pull-requests: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up CML
        uses: iterative/setup-cml@v2

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pull dataset via DVC
        env:
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install dvc==3.3.0 dvc-http==2.32.0
          dvc remote modify myremote --local auth basic
          dvc remote modify myremote --local user ${DAGSHUB_USERNAME}
          dvc remote modify myremote --local password ${DAGSHUB_TOKEN}
          dvc pull data/dataset.csv -v
          echo "=== Verification ==="
          head -1 data/dataset.csv
          wc -l data/dataset.csv

      - name: Train model
        run: python script.py

      - name: Publish CML report
        if: always()
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## Rapport MLOps - Churn Detection" > report.md
          echo "" >> report.md
          echo "### Metriques F1-Score" >> report.md
          echo '```' >> report.md
          cat metrics.txt >> report.md
          echo '```' >> report.md
          echo "" >> report.md
          echo "### Matrice de Confusion" >> report.md
          echo "![Confusion Matrix](./conf_matrix.png)" >> report.md
          cml comment create report.md